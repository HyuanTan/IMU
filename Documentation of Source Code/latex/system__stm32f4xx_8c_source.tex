\section{system\+\_\+stm32f4xx.\+c}
\label{system__stm32f4xx_8c_source}\index{C\+:/\+Users/\+Md. Istiaq Mahbub/\+Desktop/\+I\+M\+U/\+M\+P\+U6050\+\_\+\+Motion\+Driver/\+Device\+Support/src/system\+\_\+stm32f4xx.\+c@{C\+:/\+Users/\+Md. Istiaq Mahbub/\+Desktop/\+I\+M\+U/\+M\+P\+U6050\+\_\+\+Motion\+Driver/\+Device\+Support/src/system\+\_\+stm32f4xx.\+c}}

\begin{DoxyCode}
00001 \textcolor{comment}{/**}
00002 \textcolor{comment}{  ******************************************************************************}
00003 \textcolor{comment}{  * @file    system\_stm32f4xx.c}
00004 \textcolor{comment}{  * @author  MCD Application Team}
00005 \textcolor{comment}{  * @version V1.0.0}
00006 \textcolor{comment}{  * @date    30-September-2011}
00007 \textcolor{comment}{  * @brief   CMSIS Cortex-M4 Device Peripheral Access Layer System Source File.}
00008 \textcolor{comment}{  *          This file contains the system clock configuration for STM32F4xx devices,}
00009 \textcolor{comment}{  *          and is generated by the clock configuration tool}
00010 \textcolor{comment}{  *          stm32f4xx\_Clock\_Configuration\_V1.0.0.xls}
00011 \textcolor{comment}{  *             }
00012 \textcolor{comment}{  * 1.  This file provides two functions and one global variable to be called from }
00013 \textcolor{comment}{  *     user application:}
00014 \textcolor{comment}{  *      - SystemInit(): Setups the system clock (System clock source, PLL Multiplier}
00015 \textcolor{comment}{  *                      and Divider factors, AHB/APBx prescalers and Flash settings),}
00016 \textcolor{comment}{  *                      depending on the configuration made in the clock xls tool. }
00017 \textcolor{comment}{  *                      This function is called at startup just after reset and }
00018 \textcolor{comment}{  *                      before branch to main program. This call is made inside}
00019 \textcolor{comment}{  *                      the "startup\_stm32f4xx.s" file.}
00020 \textcolor{comment}{  *}
00021 \textcolor{comment}{  *      - SystemCoreClock variable: Contains the core clock (HCLK), it can be used}
00022 \textcolor{comment}{  *                                  by the user application to setup the SysTick }
00023 \textcolor{comment}{  *                                  timer or configure other parameters.}
00024 \textcolor{comment}{  *                                     }
00025 \textcolor{comment}{  *      - SystemCoreClockUpdate(): Updates the variable SystemCoreClock and must}
00026 \textcolor{comment}{  *                                 be called whenever the core clock is changed}
00027 \textcolor{comment}{  *                                 during program execution.}
00028 \textcolor{comment}{  *}
00029 \textcolor{comment}{  * 2. After each device reset the HSI (16 MHz) is used as system clock source.}
00030 \textcolor{comment}{  *    Then SystemInit() function is called, in "startup\_stm32f4xx.s" file, to}
00031 \textcolor{comment}{  *    configure the system clock before to branch to main program.}
00032 \textcolor{comment}{  *}
00033 \textcolor{comment}{  * 3. If the system clock source selected by user fails to startup, the SystemInit()}
00034 \textcolor{comment}{  *    function will do nothing and HSI still used as system clock source. User can }
00035 \textcolor{comment}{  *    add some code to deal with this issue inside the SetSysClock() function.}
00036 \textcolor{comment}{  *}
00037 \textcolor{comment}{  * 4. The default value of HSE crystal is set to 25MHz, refer to "HSE\_VALUE" define}
00038 \textcolor{comment}{  *    in "stm32f4xx.h" file. When HSE is used as system clock source, directly or}
00039 \textcolor{comment}{  *    through PLL, and you are using different crystal you have to adapt the HSE}
00040 \textcolor{comment}{  *    value to your own configuration.}
00041 \textcolor{comment}{  *}
00042 \textcolor{comment}{  * 5. This file configures the system clock as follows:}
00043 \textcolor{comment}{  *=============================================================================}
00044 \textcolor{comment}{  *=============================================================================}
00045 \textcolor{comment}{  *        Supported STM32F4xx device revision    | Rev A}
00046 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00047 \textcolor{comment}{  *        System Clock source                    | PLL (HSE)}
00048 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00049 \textcolor{comment}{  *        SYSCLK(Hz)                             | 168000000}
00050 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00051 \textcolor{comment}{  *        HCLK(Hz)                               | 168000000}
00052 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00053 \textcolor{comment}{  *        AHB Prescaler                          | 1}
00054 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00055 \textcolor{comment}{  *        APB1 Prescaler                         | 4}
00056 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00057 \textcolor{comment}{  *        APB2 Prescaler                         | 2}
00058 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00059 \textcolor{comment}{  *        HSE Frequency(Hz)                      | 25000000}
00060 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00061 \textcolor{comment}{  *        PLL\_M                                  | 25}
00062 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00063 \textcolor{comment}{  *        PLL\_N                                  | 336}
00064 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00065 \textcolor{comment}{  *        PLL\_P                                  | 2}
00066 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00067 \textcolor{comment}{  *        PLL\_Q                                  | 7}
00068 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00069 \textcolor{comment}{  *        PLLI2S\_N                               | NA}
00070 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00071 \textcolor{comment}{  *        PLLI2S\_R                               | NA}
00072 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00073 \textcolor{comment}{  *        I2S input clock                        | NA}
00074 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00075 \textcolor{comment}{  *        VDD(V)                                 | 3.3}
00076 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00077 \textcolor{comment}{  *        Main regulator output voltage          | Scale1 mode}
00078 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00079 \textcolor{comment}{  *        Flash Latency(WS)                      | 5}
00080 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00081 \textcolor{comment}{  *        Prefetch Buffer                        | OFF}
00082 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00083 \textcolor{comment}{  *        Instruction cache                      | ON}
00084 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00085 \textcolor{comment}{  *        Data cache                             | ON}
00086 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00087 \textcolor{comment}{  *        Require 48MHz for USB OTG FS,          | Enabled}
00088 \textcolor{comment}{  *        SDIO and RNG clock                     |}
00089 \textcolor{comment}{  *-----------------------------------------------------------------------------}
00090 \textcolor{comment}{  *=============================================================================}
00091 \textcolor{comment}{  ****************************************************************************** }
00092 \textcolor{comment}{  * @attention}
00093 \textcolor{comment}{  *}
00094 \textcolor{comment}{  * THE PRESENT FIRMWARE WHICH IS FOR GUIDANCE ONLY AIMS AT PROVIDING CUSTOMERS}
00095 \textcolor{comment}{  * WITH CODING INFORMATION REGARDING THEIR PRODUCTS IN ORDER FOR THEM TO SAVE}
00096 \textcolor{comment}{  * TIME. AS A RESULT, STMICROELECTRONICS SHALL NOT BE HELD LIABLE FOR ANY}
00097 \textcolor{comment}{  * DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES WITH RESPECT TO ANY CLAIMS ARISING}
00098 \textcolor{comment}{  * FROM THE CONTENT OF SUCH FIRMWARE AND/OR THE USE MADE BY CUSTOMERS OF THE}
00099 \textcolor{comment}{  * CODING INFORMATION CONTAINED HEREIN IN CONNECTION WITH THEIR PRODUCTS.}
00100 \textcolor{comment}{  *}
00101 \textcolor{comment}{  * <h2><center>&copy; COPYRIGHT 2011 STMicroelectronics</center></h2>}
00102 \textcolor{comment}{  ******************************************************************************}
00103 \textcolor{comment}{  */}
00104 
00105 \textcolor{comment}{/** @addtogroup CMSIS}
00106 \textcolor{comment}{  * @\{}
00107 \textcolor{comment}{  */}
00108 
00109 \textcolor{comment}{/** @addtogroup stm32f4xx\_system}
00110 \textcolor{comment}{  * @\{}
00111 \textcolor{comment}{  */}
00112 
00113 \textcolor{comment}{/** @addtogroup STM32F4xx\_System\_Private\_Includes}
00114 \textcolor{comment}{  * @\{}
00115 \textcolor{comment}{  */}
00116 
00117 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} "stm32f4xx.h"
00118 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} "stm32f4xx_hal_conf.h"
00119 
00120 \textcolor{comment}{/**}
00121 \textcolor{comment}{  * @\}}
00122 \textcolor{comment}{  */}
00123 
00124 \textcolor{comment}{/** @addtogroup STM32F4xx\_System\_Private\_TypesDefinitions}
00125 \textcolor{comment}{  * @\{}
00126 \textcolor{comment}{  */}
00127 
00128 \textcolor{comment}{/**}
00129 \textcolor{comment}{  * @\}}
00130 \textcolor{comment}{  */}
00131 
00132 \textcolor{comment}{/** @addtogroup STM32F4xx\_System\_Private\_Defines}
00133 \textcolor{comment}{  * @\{}
00134 \textcolor{comment}{  */}
00135 
00136 \textcolor{comment}{/************************* Miscellaneous Configuration ************************/}
00137 \textcolor{comment}{/*!< Uncomment the following line if you need to use external SRAM mounted}
00138 \textcolor{comment}{     on STM324xG\_EVAL board as data memory  */}
00139 \textcolor{comment}{/* #define DATA\_IN\_ExtSRAM */}
00140 
00141 \textcolor{comment}{/*!< Uncomment the following line if you need to relocate your vector Table in}
00142 \textcolor{comment}{     Internal SRAM. */}
00143 \textcolor{comment}{/* #define VECT\_TAB\_SRAM */}
00144 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{VECT\_TAB\_OFFSET}  0x00 \textcolor{comment}{/*!< Vector Table base offset field. }
00145 \textcolor{comment}{                                   This value must be a multiple of 0x200. */}
00146 \textcolor{comment}{/******************************************************************************/}
00147 
00148 \textcolor{comment}{/************************* PLL Parameters *************************************/}
00149 \textcolor{comment}{/* PLL\_VCO = (HSE\_VALUE or HSI\_VALUE / PLL\_M) * PLL\_N */}
00150 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{PLL\_M}      8
00151 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{PLL\_N}      336
00152 
00153 \textcolor{comment}{/* SYSCLK = PLL\_VCO / PLL\_P */}
00154 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{PLL\_P}      2
00155 
00156 \textcolor{comment}{/* USB OTG FS, SDIO and RNG Clock =  PLL\_VCO / PLLQ */}
00157 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{PLL\_Q}      7
00158 
00159 \textcolor{comment}{/******************************************************************************/}
00160 
00161 \textcolor{comment}{/**}
00162 \textcolor{comment}{  * @\}}
00163 \textcolor{comment}{  */}
00164 
00165 \textcolor{comment}{/** @addtogroup STM32F4xx\_System\_Private\_Macros}
00166 \textcolor{comment}{  * @\{}
00167 \textcolor{comment}{  */}
00168 
00169 \textcolor{comment}{/**}
00170 \textcolor{comment}{  * @\}}
00171 \textcolor{comment}{  */}
00172 
00173 \textcolor{comment}{/** @addtogroup STM32F4xx\_System\_Private\_Variables}
00174 \textcolor{comment}{  * @\{}
00175 \textcolor{comment}{  */}
00176 
00177   uint32\_t SystemCoreClock = 168000000;
00178 
00179   \_\_I uint8\_t AHBPrescTable[16] = \{0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 6, 7, 8, 9\};
00180 
00181 \textcolor{comment}{/**}
00182 \textcolor{comment}{  * @\}}
00183 \textcolor{comment}{  */}
00184 
00185 \textcolor{comment}{/** @addtogroup STM32F4xx\_System\_Private\_FunctionPrototypes}
00186 \textcolor{comment}{  * @\{}
00187 \textcolor{comment}{  */}
00188 
00189 \textcolor{keyword}{static} \textcolor{keywordtype}{void} SetSysClock(\textcolor{keywordtype}{void});
00190 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DATA\_IN\_ExtSRAM}
00191   \textcolor{keyword}{static} \textcolor{keywordtype}{void} SystemInit\_ExtMemCtl(\textcolor{keywordtype}{void});
00192 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif} \textcolor{comment}{/* DATA\_IN\_ExtSRAM */}
00193 
00194 \textcolor{comment}{/**}
00195 \textcolor{comment}{  * @\}}
00196 \textcolor{comment}{  */}
00197 
00198 \textcolor{comment}{/** @addtogroup STM32F4xx\_System\_Private\_Functions}
00199 \textcolor{comment}{  * @\{}
00200 \textcolor{comment}{  */}
00201 
00202 \textcolor{comment}{/**}
00203 \textcolor{comment}{  * @brief  Setup the microcontroller system}
00204 \textcolor{comment}{  *         Initialize the Embedded Flash Interface, the PLL and update the }
00205 \textcolor{comment}{  *         SystemFrequency variable.}
00206 \textcolor{comment}{  * @param  None}
00207 \textcolor{comment}{  * @retval None}
00208 \textcolor{comment}{  */}
00209 \textcolor{keywordtype}{void} SystemInit(\textcolor{keywordtype}{void})
00210 \{
00211   \textcolor{comment}{/* FPU settings ------------------------------------------------------------*/}
00212   \textcolor{preprocessor}{#}\textcolor{preprocessor}{if} \textcolor{preprocessor}{(}__FPU_PRESENT \textcolor{preprocessor}{==} 1\textcolor{preprocessor}{)} \textcolor{preprocessor}{&&} \textcolor{preprocessor}{(}\textcolor{preprocessor}{\_\_FPU\_USED} \textcolor{preprocessor}{==} 1\textcolor{preprocessor}{)}
00213     SCB->CPACR |= ((3UL << 10*2)|(3UL << 11*2));  \textcolor{comment}{/* set CP10 and CP11 Full Access */}
00214   \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00215 
00216   \textcolor{comment}{/* Reset the RCC clock configuration to the default reset state ------------*/}
00217   \textcolor{comment}{/* Set HSION bit */}
00218   RCC->CR |= (uint32\_t)0x00000001;
00219 
00220   \textcolor{comment}{/* Reset CFGR register */}
00221   RCC->CFGR = 0x00000000;
00222 
00223   \textcolor{comment}{/* Reset HSEON, CSSON and PLLON bits */}
00224   RCC->CR &= (uint32\_t)0xFEF6FFFF;
00225 
00226   \textcolor{comment}{/* Reset PLLCFGR register */}
00227   RCC->PLLCFGR = 0x24003010;
00228 
00229   \textcolor{comment}{/* Reset HSEBYP bit */}
00230   RCC->CR &= (uint32\_t)0xFFFBFFFF;
00231 
00232   \textcolor{comment}{/* Disable all interrupts */}
00233   RCC->CIR = 0x00000000;
00234 
00235 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DATA\_IN\_ExtSRAM}
00236   SystemInit\_ExtMemCtl();
00237 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif} \textcolor{comment}{/* DATA\_IN\_ExtSRAM */}
00238 
00239   \textcolor{comment}{/* Configure the System clock source, PLL Multiplier and Divider factors, }
00240 \textcolor{comment}{     AHB/APBx prescalers and Flash settings ----------------------------------*/}
00241   SetSysClock();
00242 
00243   \textcolor{comment}{/* Configure the Vector Table location add offset address ------------------*/}
00244 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{VECT\_TAB\_SRAM}
00245   SCB->VTOR = SRAM\_BASE | VECT\_TAB\_OFFSET; \textcolor{comment}{/* Vector Table Relocation in Internal SRAM */}
00246 \textcolor{preprocessor}{#}\textcolor{preprocessor}{else}
00247   SCB->VTOR = FLASH_BASE | VECT_TAB_OFFSET; \textcolor{comment}{/* Vector Table Relocation in Internal FLASH */}
00248 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}
00249 \}
00250 
00251 \textcolor{comment}{/**}
00252 \textcolor{comment}{   * @brief  Update SystemCoreClock variable according to Clock Register Values.}
00253 \textcolor{comment}{  *         The SystemCoreClock variable contains the core clock (HCLK), it can}
00254 \textcolor{comment}{  *         be used by the user application to setup the SysTick timer or configure}
00255 \textcolor{comment}{  *         other parameters.}
00256 \textcolor{comment}{  *           }
00257 \textcolor{comment}{  * @note   Each time the core clock (HCLK) changes, this function must be called}
00258 \textcolor{comment}{  *         to update SystemCoreClock variable value. Otherwise, any configuration}
00259 \textcolor{comment}{  *         based on this variable will be incorrect.         }
00260 \textcolor{comment}{  *     }
00261 \textcolor{comment}{  * @note   - The system frequency computed by this function is not the real }
00262 \textcolor{comment}{  *           frequency in the chip. It is calculated based on the predefined }
00263 \textcolor{comment}{  *           constant and the selected clock source:}
00264 \textcolor{comment}{  *             }
00265 \textcolor{comment}{  *           - If SYSCLK source is HSI, SystemCoreClock will contain the HSI\_VALUE(*)}
00266 \textcolor{comment}{  *                                              }
00267 \textcolor{comment}{  *           - If SYSCLK source is HSE, SystemCoreClock will contain the HSE\_VALUE(**)}
00268 \textcolor{comment}{  *                          }
00269 \textcolor{comment}{  *           - If SYSCLK source is PLL, SystemCoreClock will contain the HSE\_VALUE(**) }
00270 \textcolor{comment}{  *             or HSI\_VALUE(*) multiplied/divided by the PLL factors.}
00271 \textcolor{comment}{  *         }
00272 \textcolor{comment}{  *         (*) HSI\_VALUE is a constant defined in stm32f4xx.h file (default value}
00273 \textcolor{comment}{  *             16 MHz) but the real value may vary depending on the variations}
00274 \textcolor{comment}{  *             in voltage and temperature.   }
00275 \textcolor{comment}{  *    }
00276 \textcolor{comment}{  *         (**) HSE\_VALUE is a constant defined in stm32f4xx.h file (default value}
00277 \textcolor{comment}{  *              25 MHz), user has to ensure that HSE\_VALUE is same as the real}
00278 \textcolor{comment}{  *              frequency of the crystal used. Otherwise, this function may}
00279 \textcolor{comment}{  *              have wrong result.}
00280 \textcolor{comment}{  *                }
00281 \textcolor{comment}{  *         - The result of this function could be not correct when using fractional}
00282 \textcolor{comment}{  *           value for HSE crystal.}
00283 \textcolor{comment}{  *     }
00284 \textcolor{comment}{  * @param  None}
00285 \textcolor{comment}{  * @retval None}
00286 \textcolor{comment}{  */}
00287 \textcolor{keywordtype}{void} SystemCoreClockUpdate(\textcolor{keywordtype}{void})
00288 \{
00289   uint32\_t tmp = 0, pllvco = 0, pllp = 2, pllsource = 0, pllm = 2;
00290 
00291   \textcolor{comment}{/* Get SYSCLK source -------------------------------------------------------*/}
00292   tmp = RCC->CFGR & RCC_CFGR_SWS;
00293 
00294   \textcolor{keywordflow}{switch} (tmp)
00295   \{
00296     \textcolor{keywordflow}{case} 0x00:  \textcolor{comment}{/* HSI used as system clock source */}
00297       SystemCoreClock = HSI_VALUE;
00298       \textcolor{keywordflow}{break};
00299     \textcolor{keywordflow}{case} 0x04:  \textcolor{comment}{/* HSE used as system clock source */}
00300       SystemCoreClock = HSE_VALUE;
00301       \textcolor{keywordflow}{break};
00302     \textcolor{keywordflow}{case} 0x08:  \textcolor{comment}{/* PLL used as system clock source */}
00303 
00304       \textcolor{comment}{/* PLL\_VCO = (HSE\_VALUE or HSI\_VALUE / PLL\_M) * PLL\_N}
00305 \textcolor{comment}{         SYSCLK = PLL\_VCO / PLL\_P}
00306 \textcolor{comment}{         */}
00307       pllsource = (RCC->PLLCFGR & RCC_PLLCFGR_PLLSRC) >> 22;
00308       pllm = RCC->PLLCFGR & RCC_PLLCFGR_PLLM;
00309 
00310       \textcolor{keywordflow}{if} (pllsource != 0)
00311       \{
00312         \textcolor{comment}{/* HSE used as PLL clock source */}
00313         pllvco = (HSE_VALUE / pllm) * ((RCC->PLLCFGR & RCC_PLLCFGR_PLLN) >> 6);
00314       \}
00315       \textcolor{keywordflow}{else}
00316       \{
00317         \textcolor{comment}{/* HSI used as PLL clock source */}
00318         pllvco = (HSI_VALUE / pllm) * ((RCC->PLLCFGR & RCC_PLLCFGR_PLLN) >> 6);
00319       \}
00320 
00321       pllp = (((RCC->PLLCFGR & RCC_PLLCFGR_PLLP) >>16) + 1 ) *2;
00322       SystemCoreClock = pllvco/pllp;
00323       \textcolor{keywordflow}{break};
00324     \textcolor{keywordflow}{default}:
00325       SystemCoreClock = HSI_VALUE;
00326       \textcolor{keywordflow}{break};
00327   \}
00328   \textcolor{comment}{/* Compute HCLK frequency --------------------------------------------------*/}
00329   \textcolor{comment}{/* Get HCLK prescaler */}
00330   tmp = AHBPrescTable[((RCC->CFGR & RCC_CFGR_HPRE) >> 4)];
00331   \textcolor{comment}{/* HCLK frequency */}
00332   SystemCoreClock >>= tmp;
00333 \}
00334 
00335 \textcolor{comment}{/**}
00336 \textcolor{comment}{  * @brief  Configures the System clock source, PLL Multiplier and Divider factors, }
00337 \textcolor{comment}{  *         AHB/APBx prescalers and Flash settings}
00338 \textcolor{comment}{  * @Note   This function should be called only once the RCC clock configuration  }
00339 \textcolor{comment}{  *         is reset to the default reset state (done in SystemInit() function).   }
00340 \textcolor{comment}{  * @param  None}
00341 \textcolor{comment}{  * @retval None}
00342 \textcolor{comment}{  */}
00343 \textcolor{keyword}{static} \textcolor{keywordtype}{void} SetSysClock(\textcolor{keywordtype}{void})
00344 \{
00345 \textcolor{comment}{/******************************************************************************/}
00346 \textcolor{comment}{/*            PLL (clocked by HSE) used as System clock source                */}
00347 \textcolor{comment}{/******************************************************************************/}
00348   \_\_IO uint32\_t StartUpCounter = 0, HSEStatus = 0;
00349 
00350   \textcolor{comment}{/* Enable HSE */}
00351   RCC->CR |= ((uint32\_t)RCC_CR_HSEON);
00352 
00353   \textcolor{comment}{/* Wait till HSE is ready and if Time out is reached exit */}
00354   \textcolor{keywordflow}{do}
00355   \{
00356     HSEStatus = RCC->CR & RCC_CR_HSERDY;
00357     StartUpCounter++;
00358   \} \textcolor{keywordflow}{while}((HSEStatus == 0) && (StartUpCounter != HSE_STARTUP_TIMEOUT));
00359 
00360   \textcolor{keywordflow}{if} ((RCC->CR & RCC_CR_HSERDY) != RESET)
00361   \{
00362     HSEStatus = (uint32\_t)0x01;
00363   \}
00364   \textcolor{keywordflow}{else}
00365   \{
00366     HSEStatus = (uint32\_t)0x00;
00367   \}
00368 
00369   \textcolor{keywordflow}{if} (HSEStatus == (uint32\_t)0x01)
00370   \{
00371     \textcolor{comment}{/* Select regulator voltage output Scale 1 mode, System frequency up to 168 MHz */}
00372     RCC->APB1ENR |= RCC_APB1ENR_PWREN;
00373     PWR->CR |= PWR_CR_VOS;
00374 
00375     \textcolor{comment}{/* HCLK = SYSCLK / 1*/}
00376     RCC->CFGR |= RCC_CFGR_HPRE_DIV1;
00377 
00378     \textcolor{comment}{/* PCLK2 = HCLK / 2*/}
00379     RCC->CFGR |= RCC_CFGR_PPRE2_DIV2;
00380 
00381     \textcolor{comment}{/* PCLK1 = HCLK / 4*/}
00382     RCC->CFGR |= RCC_CFGR_PPRE1_DIV4;
00383 
00384     \textcolor{comment}{/* Configure the main PLL */}
00385     RCC->PLLCFGR = PLL_M | (PLL_N << 6) | (((PLL_P >> 1) -1) << 16) |
00386                    (RCC_PLLCFGR_PLLSRC_HSE) | (PLL_Q << 24);
00387 
00388     \textcolor{comment}{/* Enable the main PLL */}
00389     RCC->CR |= RCC_CR_PLLON;
00390 
00391     \textcolor{comment}{/* Wait till the main PLL is ready */}
00392     \textcolor{keywordflow}{while}((RCC->CR & RCC_CR_PLLRDY) == 0)
00393     \{
00394     \}
00395 
00396     \textcolor{comment}{/* Configure Flash prefetch, Instruction cache, Data cache and wait state */}
00397     FLASH->ACR = FLASH_ACR_ICEN |FLASH_ACR_DCEN |FLASH_ACR_LATENCY_5WS;
00398 
00399     \textcolor{comment}{/* Select the main PLL as system clock source */}
00400     RCC->CFGR &= (uint32\_t)((uint32\_t)~(RCC_CFGR_SW));
00401     RCC->CFGR |= RCC_CFGR_SW_PLL;
00402 
00403     \textcolor{comment}{/* Wait till the main PLL is used as system clock source */}
00404     \textcolor{keywordflow}{while} ((RCC->CFGR & (uint32\_t)RCC_CFGR_SWS ) != RCC_CFGR_SWS_PLL);
00405     \{
00406     \}
00407   \}
00408   \textcolor{keywordflow}{else}
00409   \{ \textcolor{comment}{/* If HSE fails to start-up, the application will have wrong clock}
00410 \textcolor{comment}{         configuration. User can add here some code to deal with this error */}
00411   \}
00412 
00413 \}
00414 
00415 \textcolor{comment}{/**}
00416 \textcolor{comment}{  * @brief  Setup the external memory controller. Called in startup\_stm32f4xx.s }
00417 \textcolor{comment}{  *          before jump to \_\_main}
00418 \textcolor{comment}{  * @param  None}
00419 \textcolor{comment}{  * @retval None}
00420 \textcolor{comment}{  */}
00421 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifdef} \textcolor{preprocessor}{DATA\_IN\_ExtSRAM}
00422 \textcolor{comment}{/**}
00423 \textcolor{comment}{  * @brief  Setup the external memory controller.}
00424 \textcolor{comment}{  *         Called in startup\_stm32f4xx.s before jump to main.}
00425 \textcolor{comment}{  *         This function configures the external SRAM mounted on STM324xG\_EVAL board}
00426 \textcolor{comment}{  *         This SRAM will be used as program data memory (including heap and stack).}
00427 \textcolor{comment}{  * @param  None}
00428 \textcolor{comment}{  * @retval None}
00429 \textcolor{comment}{  */}
00430 \textcolor{keywordtype}{void} SystemInit\_ExtMemCtl(\textcolor{keywordtype}{void})
00431 \{
00432 \textcolor{comment}{/*-- GPIOs Configuration -----------------------------------------------------*/}
00433 \textcolor{comment}{/*}
00434 \textcolor{comment}{ +-------------------+--------------------+------------------+------------------+}
00435 \textcolor{comment}{ +                       SRAM pins assignment                                   +}
00436 \textcolor{comment}{ +-------------------+--------------------+------------------+------------------+}
00437 \textcolor{comment}{ | PD0  <-> FSMC\_D2  | PE0  <-> FSMC\_NBL0 | PF0  <-> FSMC\_A0 | PG0 <-> FSMC\_A10 | }
00438 \textcolor{comment}{ | PD1  <-> FSMC\_D3  | PE1  <-> FSMC\_NBL1 | PF1  <-> FSMC\_A1 | PG1 <-> FSMC\_A11 | }
00439 \textcolor{comment}{ | PD4  <-> FSMC\_NOE | PE3  <-> FSMC\_A19  | PF2  <-> FSMC\_A2 | PG2 <-> FSMC\_A12 | }
00440 \textcolor{comment}{ | PD5  <-> FSMC\_NWE | PE4  <-> FSMC\_A20  | PF3  <-> FSMC\_A3 | PG3 <-> FSMC\_A13 | }
00441 \textcolor{comment}{ | PD8  <-> FSMC\_D13 | PE7  <-> FSMC\_D4   | PF4  <-> FSMC\_A4 | PG4 <-> FSMC\_A14 | }
00442 \textcolor{comment}{ | PD9  <-> FSMC\_D14 | PE8  <-> FSMC\_D5   | PF5  <-> FSMC\_A5 | PG5 <-> FSMC\_A15 | }
00443 \textcolor{comment}{ | PD10 <-> FSMC\_D15 | PE9  <-> FSMC\_D6   | PF12 <-> FSMC\_A6 | PG9 <-> FSMC\_NE2 | }
00444 \textcolor{comment}{ | PD11 <-> FSMC\_A16 | PE10 <-> FSMC\_D7   | PF13 <-> FSMC\_A7 |------------------+}
00445 \textcolor{comment}{ | PD12 <-> FSMC\_A17 | PE11 <-> FSMC\_D8   | PF14 <-> FSMC\_A8 | }
00446 \textcolor{comment}{ | PD13 <-> FSMC\_A18 | PE12 <-> FSMC\_D9   | PF15 <-> FSMC\_A9 | }
00447 \textcolor{comment}{ | PD14 <-> FSMC\_D0  | PE13 <-> FSMC\_D10  |------------------+}
00448 \textcolor{comment}{ | PD15 <-> FSMC\_D1  | PE14 <-> FSMC\_D11  |}
00449 \textcolor{comment}{ |                   | PE15 <-> FSMC\_D12  |}
00450 \textcolor{comment}{ +-------------------+--------------------+}
00451 \textcolor{comment}{*/}
00452    \textcolor{comment}{/* Enable GPIOD, GPIOE, GPIOF and GPIOG interface clock */}
00453   RCC->AHB1ENR   = 0x00000078;
00454 
00455   \textcolor{comment}{/* Connect PDx pins to FSMC Alternate function */}
00456   GPIOD->AFR[0]  = 0x00cc00cc;
00457   GPIOD->AFR[1]  = 0xcc0ccccc;
00458   \textcolor{comment}{/* Configure PDx pins in Alternate function mode */}
00459   GPIOD->MODER   = 0xaaaa0a0a;
00460   \textcolor{comment}{/* Configure PDx pins speed to 100 MHz */}
00461   GPIOD->OSPEEDR = 0xffff0f0f;
00462   \textcolor{comment}{/* Configure PDx pins Output type to push-pull */}
00463   GPIOD->OTYPER  = 0x00000000;
00464   \textcolor{comment}{/* No pull-up, pull-down for PDx pins */}
00465   GPIOD->PUPDR   = 0x00000000;
00466 
00467   \textcolor{comment}{/* Connect PEx pins to FSMC Alternate function */}
00468   GPIOE->AFR[0]  = 0xc00cc0cc;
00469   GPIOE->AFR[1]  = 0xcccccccc;
00470   \textcolor{comment}{/* Configure PEx pins in Alternate function mode */}
00471   GPIOE->MODER   = 0xaaaa828a;
00472   \textcolor{comment}{/* Configure PEx pins speed to 100 MHz */}
00473   GPIOE->OSPEEDR = 0xffffc3cf;
00474   \textcolor{comment}{/* Configure PEx pins Output type to push-pull */}
00475   GPIOE->OTYPER  = 0x00000000;
00476   \textcolor{comment}{/* No pull-up, pull-down for PEx pins */}
00477   GPIOE->PUPDR   = 0x00000000;
00478 
00479   \textcolor{comment}{/* Connect PFx pins to FSMC Alternate function */}
00480   GPIOF->AFR[0]  = 0x00cccccc;
00481   GPIOF->AFR[1]  = 0xcccc0000;
00482   \textcolor{comment}{/* Configure PFx pins in Alternate function mode */}
00483   GPIOF->MODER   = 0xaa000aaa;
00484   \textcolor{comment}{/* Configure PFx pins speed to 100 MHz */}
00485   GPIOF->OSPEEDR = 0xff000fff;
00486   \textcolor{comment}{/* Configure PFx pins Output type to push-pull */}
00487   GPIOF->OTYPER  = 0x00000000;
00488   \textcolor{comment}{/* No pull-up, pull-down for PFx pins */}
00489   GPIOF->PUPDR   = 0x00000000;
00490 
00491   \textcolor{comment}{/* Connect PGx pins to FSMC Alternate function */}
00492   GPIOG->AFR[0]  = 0x00cccccc;
00493   GPIOG->AFR[1]  = 0x000000c0;
00494   \textcolor{comment}{/* Configure PGx pins in Alternate function mode */}
00495   GPIOG->MODER   = 0x00080aaa;
00496   \textcolor{comment}{/* Configure PGx pins speed to 100 MHz */}
00497   GPIOG->OSPEEDR = 0x000c0fff;
00498   \textcolor{comment}{/* Configure PGx pins Output type to push-pull */}
00499   GPIOG->OTYPER  = 0x00000000;
00500   \textcolor{comment}{/* No pull-up, pull-down for PGx pins */}
00501   GPIOG->PUPDR   = 0x00000000;
00502 
00503 \textcolor{comment}{/*-- FSMC Configuration ------------------------------------------------------*/}
00504   \textcolor{comment}{/* Enable the FSMC interface clock */}
00505   RCC->AHB3ENR         = 0x00000001;
00506 
00507   \textcolor{comment}{/* Configure and enable Bank1\_SRAM2 */}
00508   FSMC\_Bank1->BTCR[2]  = 0x00001015;
00509   FSMC\_Bank1->BTCR[3]  = 0x00010603;
00510   FSMC\_Bank1E->BWTR[2] = 0x0fffffff;
00511 \textcolor{comment}{/*}
00512 \textcolor{comment}{  Bank1\_SRAM2 is configured as follow:}
00513 \textcolor{comment}{}
00514 \textcolor{comment}{  p.FSMC\_AddressSetupTime = 3;}
00515 \textcolor{comment}{  p.FSMC\_AddressHoldTime = 0;}
00516 \textcolor{comment}{  p.FSMC\_DataSetupTime = 6;}
00517 \textcolor{comment}{  p.FSMC\_BusTurnAroundDuration = 1;}
00518 \textcolor{comment}{  p.FSMC\_CLKDivision = 0;}
00519 \textcolor{comment}{  p.FSMC\_DataLatency = 0;}
00520 \textcolor{comment}{  p.FSMC\_AccessMode = FSMC\_AccessMode\_A;}
00521 \textcolor{comment}{}
00522 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_Bank = FSMC\_Bank1\_NORSRAM2;}
00523 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_DataAddressMux = FSMC\_DataAddressMux\_Disable;}
00524 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_MemoryType = FSMC\_MemoryType\_PSRAM;}
00525 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_MemoryDataWidth = FSMC\_MemoryDataWidth\_16b;}
00526 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_BurstAccessMode = FSMC\_BurstAccessMode\_Disable;}
00527 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_AsynchronousWait = FSMC\_AsynchronousWait\_Disable;  }
00528 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_WaitSignalPolarity = FSMC\_WaitSignalPolarity\_Low;}
00529 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_WrapMode = FSMC\_WrapMode\_Disable;}
00530 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_WaitSignalActive = FSMC\_WaitSignalActive\_BeforeWaitState;}
00531 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_WriteOperation = FSMC\_WriteOperation\_Enable;}
00532 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_WaitSignal = FSMC\_WaitSignal\_Disable;}
00533 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_ExtendedMode = FSMC\_ExtendedMode\_Disable;}
00534 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_WriteBurst = FSMC\_WriteBurst\_Disable;}
00535 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_ReadWriteTimingStruct = &p;}
00536 \textcolor{comment}{  FSMC\_NORSRAMInitStructure.FSMC\_WriteTimingStruct = &p;}
00537 \textcolor{comment}{*/}
00538 
00539 \}
00540 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif} \textcolor{comment}{/* DATA\_IN\_ExtSRAM */}
00541 
00542 
00543 \textcolor{comment}{/**}
00544 \textcolor{comment}{  * @\}}
00545 \textcolor{comment}{  */}
00546 
00547 \textcolor{comment}{/**}
00548 \textcolor{comment}{  * @\}}
00549 \textcolor{comment}{  */}
00550 
00551 \textcolor{comment}{/**}
00552 \textcolor{comment}{  * @\}}
00553 \textcolor{comment}{  */}
00554 \textcolor{comment}{/******************* (C) COPYRIGHT 2011 STMicroelectronics *****END OF FILE****/}
\end{DoxyCode}
